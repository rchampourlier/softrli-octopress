<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: sysadmin | softr.li]]></title>
  <link href="http://www.softr.li/blog/categories/sysadmin/atom.xml" rel="self"/>
  <link href="http://www.softr.li/"/>
  <updated>2012-05-19T11:59:07+02:00</updated>
  <id>http://www.softr.li/</id>
  <author>
    <name><![CDATA[Romain Champourlier]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Organization for provisioning your environments (from dev to prod) with Chef]]></title>
    <link href="http://www.softr.li/blog/2012/05/19/organization-for-provisioning-your-environments-from-dev-to-prod-with-chef/"/>
    <updated>2012-05-19T11:56:00+02:00</updated>
    <id>http://www.softr.li/blog/2012/05/19/organization-for-provisioning-your-environments-from-dev-to-prod-with-chef</id>
    <content type="html"><![CDATA[<p>When you start developping a project with a team, you may start facing issues requiring you to share the same development environment. I just discovered <a href="www.vagrantup.com">Vagrant</a> and it's the perfect solution for doing this.</p>

<p>Vagrant is nice, but it stills requires you to provision your machine with the needed language stacks, services, etc. This is why it's provided with a way to hook into Chef or Puppet.</p>

<p><em>I'll go with Chef because I had already given it a try sometime ago, and config files are written in Ruby, which I know.</em></p>

<p>Since you're going to build recipes and/or cookbooks <strong>to provision your development machine, what about going a little further and using Chef to provision your staging/production machines too?</strong></p>

<!-- more -->


<p>There will be differences between your development and staging/production setups. However, you will have to install the same databases, maybe some background processors and some other services, so most of the provisioning that you will prepare for your development machine can be reused to provision your staging/production machines too.</p>

<h3>Purpose</h3>

<p>The purpose of this tutorial <strong>is not to be a complete walkthrough</strong> for doing this, since this would involve explaining how to build Chef recipes/cookbooks, running Chef-Solo, etc. It only intends to let you imagine what you could do to ease your provisioning process, knowing the tools exist and they can be used like this. Plus I propose a simple organization for your configuration files that may help you with it.</p>

<h3>Tools</h3>

<h4>Chef</h4>

<p>Chef is a configuration manager which will read a recipe and use cookbooks to perform operations on a given machine (or node).</p>

<p>It has several architectures:</p>

<ul>
<li><strong>Chef Client/Server</strong>: the node performing the operations is the Chef Client and the operations to be performed are determined thanks to a Chef Server. This solution provides some advantages because the server can remember some information on the state of each node. Opscode provides an <a href="http://www.opscode.com/hosted-chef/">Hosted Chef Server</a> for free up to 5 nodes.</li>
<li><strong>Chef Solo</strong>: the node performing the operations is running Chef Solo and the operations to be performed are defined by local files (or a <code>tgz</code> which can be downloaded from somewhere). It's the fast way, and should be sufficient for provisioning your development machines and a few staging/production machines.</li>
</ul>


<p>For the installation of any of the two solutions, please refer to <a href="http://www.opscode.com/chef/">Opscode's documentation</a>. For your Vagrant machines, no installation needed, everything is already <a href="http://vagrantup.com/docs/getting-started/provisioning.html">hooked in</a>.</p>

<h4>Puppet</h4>

<p>An alternative for Chef is Puppet, which can be hooked into Vagrant too. I won't detail it since I never tried it...</p>

<h4>Librarian</h4>

<p><a href="https://github.com/applicationsonline/librarian">Librarian</a> is a useful tool which will help you bundle your cookbooks.</p>

<p>To build your recipe and provisioning configuration, you will rely on cookbooks, most of them defined and shared by the community. You will find many on Github, the main repositories being provided by <a href="https://github.com/opscode-cookbooks/">Opscode</a>.</p>

<p>With Librarian you build a <code>Cheffile</code> and the principle is almost the same as Bundler for gems: you list the required cookbooks, you can specify their location and the version you want to use, and Librarian will gather them for you, ensuring the correct version of the cookbook is fetched, so that you won't get a broken version if it gets updated.</p>

<p>Once you've created the <code>Cheffile</code>, it's almost as simple as:</p>

<p><code>
gem install librarian
librarian-chef install
</code></p>

<h3>Organization</h3>

<p>How to organize all this for the provisioning of machines related to your project? Here's my approach, starting with the files-tree:</p>

<p>```
+ project
  + machines</p>

<pre><code>+ cookbooks
  ...
  &lt;the cookbooks directories generated by Librarian&gt;
  ...
+ cookbooks_local
  + project
    + recipes
      - default.rb
      - development.rb
      - staging.rb
      - production.rb
    - metadata.json
+ operations
  - provision_development.json
  - provision_staging.json
  - provision_production.json
+ roles
  - base.json
  - databases.json
  - maintenance.json
  - ruby.json
- Cheffile
- Cheffile.lock
- solo.rb
</code></pre>

<p>```</p>

<h4><code>cookbooks</code></h4>

<p>This is the directory of cookbooks generated by Librarian according to the content of your <code>Cheffile</code>.</p>

<p>Please notice the <code>Cheffile.lock</code> file which will keep the references to the cookbooks versions you have actually installed. This allows you to restore the <code>cookbooks</code> directory with the same versions of the cookbooks even if you did not specified particular versions of the cookbooks. This way, you don't need to commit your <code>cookbooks</code> directory with your versioning system.</p>

<h4><code>cookbooks_local</code></h4>

<p>This directory contains the cookbooks you maintain yourself and that you will use to setup your own environments.</p>

<p>Inside, I have a <code>project</code> cookbook containing recipes for any of the different environments I have to setup: development, staging, production.</p>

<p>The best way to build this cookbook is to look at others, and customize as needed. I have a <code>metadata.json</code> which describes the cookbook. I'm not sure it's required, but I think it's better to have it.</p>

<h4><code>operations</code></h4>

<p>When you want Chef to perform operations on a node, you provide it with a <em>run list</em> and some <em>attributes</em>. For Chef Client/Server, this is defined on the server. For Chef Solo, you generally provide the <code>chef-solo</code> command with a JSON file (often named <code>dna.json</code>).</p>

<p>Here instead of one <code>dna.json</code> file, I keep several files allowing me to run different sets of operations. For example here is the content of my <code>provision_development.json</code> file:</p>

<p>```javascript
{
  "run_list": [</p>

<pre><code>"role[base]",
"role[ruby]",
"role[databases]",
"recipe[project::development]"
</code></pre>

<p>  ],</p>

<p>  "ruby_stack": {</p>

<pre><code>"rubies": ["1.9.2-p290"],
"global": "1.9.2-p290",
"users": "vagrant"
</code></pre>

<p>  },</p>

<p>  "postgresql": {</p>

<pre><code>"password": {
  "postgres": "password"
}
</code></pre>

<p>  }
}
<code>``
This file provides Chef-Solo with a run list, which will run several roles (defined in the different JSON files under</code>roles` and described in the next paragraph), recipes, and define the attributes that may be required by the different recipes.</p>

<p>Why several configuration files? Because for my production environment, I will want to run another role: <code>role[maintenance]</code>  which will provision a set of tools to help me with maintenance tasks, and use another recipe for the project's specific provisioning: <code>recipe[project::production]</code>.</p>

<h4><code>roles</code></h4>

<p>The roles are a simple concept allowing you to bundle a set of recipes together.</p>

<p>Here is our <code>base.json</code> role file:</p>

<p>```
{
  "name": "base",
  "description": "Base role applied to all nodes.",
  "chef_type": "role",
  "json_class": "Chef::Role",</p>

<p>  "run_list": [</p>

<pre><code>"recipe[apt]",
"recipe[build-essential]",
"recipe[git]"
</code></pre>

<p>  ]
}
```</p>

<p>As you can see, it allows us to group several recipes depending on the role of the machine:</p>

<ul>
<li><code>base</code> will be provisioned on all nodes,</li>
<li><code>ruby</code> will be provisioned for nodes requiring it,</li>
<li><code>databases</code> will be provisioned for nodes acting as databases servers,</li>
<li>etc.</li>
</ul>


<h4>Cheffile</h4>

<p>That's the file used by Librarian to get the required cookbooks. It takes this form:</p>

<p>```
site "http://community.opscode.com/api/v1"</p>

<p>cookbook "apt"
cookbook 'build-essential'
cookbook 'git'
...
cookbook 'ruby_build',
  :git => 'https://github.com/fnichol/chef-ruby_build.git',
  :ref => 'v0.6.2'</p>

<p>```</p>

<p>The first line starting with <code>site</code> allows you to get the cookbooks from Opscode community easily. You can also specify a location (git, local), for the cookbooks not available on this community. Just check <a href="https://github.com/applicationsonline/librarian">Librarian's documentation</a>.</p>

<h4><code>solo.rb</code></h4>

<p>That's the configuration file we use to run Chef-Solo. Here is the content for this configuration:</p>

<p>```</p>

<h1>chef-solo -c ./solo.rb -j ./operations/operation.json</h1>

<p>file_cache_path "/tmp/chef"
cookbook_path [File.expand_path('../cookbooks', <strong>FILE</strong>), File.expand_path('../cookbooks_local', <strong>FILE</strong>)]
role_path "#{File.expand_path('../roles', <strong>FILE</strong>)}"
log_level :info
log_location STDOUT
ssl_verify_mode :verify_none</p>

<p>```</p>

<p>Notice the <code>cookbook_path</code> which is provided with an Array containing both the <code>cookbooks</code> and the <code>cookbooks_local</code> directories.</p>

<h3>Time to run</h3>

<p>Assuming you have Chef-Solo installed on the machine you want to run the operations on, you should be good with running:</p>

<p><code>
cd &lt;your-project&gt;
cd machines
[sudo] chef-solo -c ./solo.rb -j ./operations/&lt;operation&gt;.json
</code></p>

<p>Be sure to have installed the cookbooks before however (see the Librarian paragraph if you don't now what to do).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting up log rotation for your web apps]]></title>
    <link href="http://www.softr.li/blog/2012/04/20/setting-up-log-rotation-for-your-web-apps/"/>
    <updated>2012-04-20T10:12:00+02:00</updated>
    <id>http://www.softr.li/blog/2012/04/20/setting-up-log-rotation-for-your-web-apps</id>
    <content type="html"><![CDATA[<p><span class='pullquote-right' data-pullquote='Just ask yourself this question: did you configure your logs rotation? '>
If, like me, you simply follow the common tutorials and walthroughs to setup your production environment, you may start wondering after some weeks <strong>where this leak on your server's disk space is coming from...</strong></p>

<p>Just ask yourself this question: did you configure your logs rotation?</p>

<p><em>(Well, that was when I was still a young CTO...)</em>
</span></p>

<!-- more -->


<h2>The ugly</h2>

<p>You've installed your <strong>nginx</strong> server, it proxies some well-coded <strong>Rails</strong> applications served by the nice-and-fast <strong>thin</strong> app server. All good.</p>

<p>But you know, these are verbose people. They like to talk. A lot. And as obedient software, they write every character of their chatter. So this is where your leak is coming from.</p>

<p>As a matter of fact, if you don't tell somebody to clean their mess, nobody won't... and you're server will soon die of low-disk-space agony.</p>

<h2>The bad</h2>

<p>You will have to tell <code>logrotate</code> to do some work for these guys to keep their chatter under control.</p>

<p><code>logrotate</code> is the cowboy which will rule the land ;) Tell it which log has to be rotated and it will automatically does the job for you. So now, get into this configuration stage...</p>

<p>The <code>logrotate</code> configuration file should be <code>/etc/logrotate.conf</code>.</p>

<p>You can add your instructions for log rotation by adding the following lines in this file, or you can create a new file under <code>/etc/logrotate.d</code> if you think this is a more organized way (I think). This latter option mimics the way packages configure <code>logrotate</code>. You will find several examples in this directory, so you may just look at them too.</p>

<p><code>
/path/to/your/rails/applicaton/log/*.log {
  daily
  missingok
  rotate 7
  compress
  delaycompress
  notifempty
  copytruncate
}
</code></p>

<p>If you want to force <code>logrotate</code> to run right now instead of waiting until tomorrow to see if your configuration is OK, you can run this command:</p>

<pre><code>/usr/sbin/logrotate -f /etc/logrotate.conf
</code></pre>

<p>Else you can just wait a little.</p>

<h2>The good</h2>

<p>If you got through all this useless blabber about bad guys chatting and cowboys, you'll be happy to know that some serious<del>ly boring</del> (no no, just kidding, I don't even know him) guy has written a far more efficient tutorial on the subject, and you can find it <a href="http://www.nullislove.com/2007/09/10/rotating-rails-log-files/">here</a>.</p>

<p>This guide will help you understand how <code>logrotate</code> works and the purpose of each line in the code above.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Moving from RVM to rbenv]]></title>
    <link href="http://www.softr.li/blog/2012/04/10/moving-from-rvm-to-rbenv/"/>
    <updated>2012-04-10T09:56:00+02:00</updated>
    <id>http://www.softr.li/blog/2012/04/10/moving-from-rvm-to-rbenv</id>
    <content type="html"><![CDATA[<ul>
<li>Using <strong>rvm</strong> to manage your gemset without really knowing why since now Bundler does it very cleverly?</li>
<li>Feeling that the whole rvm system is a bit complicated?</li>
<li>Tired of having shell scripts not finding your rvm-managed gems?</li>
</ul>


<p>It looks like your ready to consider <strong>rbenv</strong>, which is a really lightweight alternative to <strong>rvm</strong>. Lightweight because it <em>just</em> manages rubies, and lets Bundler manage the gems.</p>

<!-- more -->


<h2>Why?</h2>

<p><strong>RVM</strong> is a very useful tool that helps you manage your ruby environment when you need multiple rubies and have tons of gems different for each of your projects.</p>

<p>I used <strong>RVM</strong> a long time on my development machine, however I did not bother to keep it on my production environment. Launching ruby applications through other ruby tools (e.g. God) or <code>crontab</code> was causing me headaches (loading RVM path, bundle not found, etc.). Since the gems were not managed by RVM, thanks to the excellent <a href="http://gembundler.com/">Bundler</a>, it was a lot of pain for a poor service.</p>

<p>On the other hand, <strong>rbenv</strong> is really simple and powerful, but it only manages rubies, not gems. But again, we have <strong>Bundler</strong>, so it's all that we need.</p>

<p>I will not say that using <strong>rbenv</strong> on a production server is painless, you still have to do some work to load some rbenv-things in your environment, but it's a lot more clear and easy than with <strong>RVM</strong>...</p>

<h2>Uninstall RVM</h2>

<p>Start with the RVM auto-uninstall command:</p>

<pre><code>rvm implode
</code></pre>

<p>Check your filesystem for other <code>rvm</code> files which may remain: <code>.rvmrc</code> files, maybe <code>/etc/rvmrc</code>. Use <code>find / -name 'rvm' -print</code> or <code>locate rvm</code> for example.</p>

<h2>Install rbenv with ruby-build plugin</h2>

<p>Install <strong>rbenv</strong> by following <a href="https://github.com/sstephenson/rbenv#section_2.1">the project's installation tutorial using GitHub checkout</a>. <strong>Read the following before doing the install!</strong></p>

<p>Be sure to adjust the file to which you append your environments changes (steps 2 and 3) to the one your using on your system (<code>.bash_profile</code> in the tutorial, <code>.profile</code> on my Mac system, but you may have <code>.bashrc</code> too).</p>

<p><strong>Stop at the end of step 3</strong>, <strong>restart your term</strong> (close and reopen, sure to work while step 4 <code>exec $SHELL</code> did nothing for me) and do the following to have a simple way of installing rubies:</p>

<pre><code>$ mkdir -p ~/.rbenv/plugins
$ cd ~/.rbenv/plugins
$ git clone git://github.com/sstephenson/ruby-build.git
</code></pre>

<p>If you've done this after step 4, you can just use this command to install the ruby you need, e.g. <code>1.9.2-p290</code>:</p>

<pre><code>rbenv install 1.9.2-p290
</code></pre>

<p>Don't forget to do step 6, <code>rbenv rehash</code>.</p>

<h2>Define rbenv's default ruby</h2>

<p>Create the <code>~/.rbenv/default</code> file with the following content, adjusted to your desired ruby:</p>

<pre><code>ruby-1.9.2-p290
</code></pre>

<h2>Configure Bundler to manage gemsets</h2>

<p>As a replacement to <strong>RVM</strong>'s gemsets feature, we will use <strong>Bundler</strong>. We will thus ask it to systematically install the gems inside the project's <code>vendor/bundle</code> directory, instead of using the system's default path.</p>

<p>To do this, create the <code>~/.bundle/config</code> file and add this content:</p>

<pre><code>---
   BUNDLE_PATH: vendor/bundle
</code></pre>

<p>You can check the configuration is OK by <code>cd</code>-ing into one of your projects' directory (assuming it's using <strong>Bundle</strong> and so you have a <strong>Gemfile</strong>), and running <code>bundle config</code>. If the configuration is OK, you should have this showed:</p>

<pre><code>path
  Set for the current user (/Users/&lt;your_name&gt;/.bundle/config): "vendor/bundle"
</code></pre>

<h2>Using (and aliasing) bundle exec</h2>

<p>Using Bundler to manage your gemsets will now require you to use <code>bundle exec</code> for <strong>every</strong> ruby command you run, even <code>rails server</code> or <code>rails console</code> (they don't need <code>bundle exec</code> to load Bundle, however you need Bundler to find them!).</p>

<p>A nice thing to do is to alias the <code>bundle exec</code> command to something shorter. I use <code>be</code>. Add this to your <code>~/.bash_profile</code>, <code>~/.profile</code> or whatever file you use:</p>

<pre><code>alias be='bundle exec'
</code></pre>

<p>So now you can run: <code>be rails console</code> instead of <code>bundle exec rails console</code>.</p>

<h2>The end</h2>

<p>That's it, you're done!</p>

<h2>References / credits</h2>

<p>This walkthrough is based on <a href="http://snippets.aktagon.com/snippets/532-How-to-migrate-from-rvm-to-rbenv">this article</a> I used a lot myself, but I finally rewrote it to include some more details on the <strong>rbenv</strong> installation process.</p>

<h2>Hubticle tags</h2>

<p>ruby, RVM, rbenv, gem, gemset, development, environment, bundle</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Adding SSL on some pages of your Rails application]]></title>
    <link href="http://www.softr.li/blog/2012/03/23/adding-ssl-on-some-pages-of-your-rails-application/"/>
    <updated>2012-03-23T09:49:00+01:00</updated>
    <id>http://www.softr.li/blog/2012/03/23/adding-ssl-on-some-pages-of-your-rails-application</id>
    <content type="html"><![CDATA[<p>This tutorial should help you to setup SSL on your <em>staging</em> and <em>production</em> servers as well as update your Rails application to require SSL for specific controller actions.</p>

<!-- more -->


<h2>Generate a self-signed certificate to test on your staging server</h2>

<p>We start by creating a self-signed certificate you will be able to use on your test/staging server, before buying a real certificate and configuring your production machine with it.</p>

<p><em>On your server console</em></p>

<pre><code>openssl genrsa -aes256 -out server.key 2048
openssl req -new -key server.key -out server.csr
openssl rsa -in server.key.bak -out server.key
sudo openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</code></pre>

<p>What does it do?</p>

<ul>
<li>Generates a private/public key pair</li>
<li>Creates a certificate request

<ul>
<li>You <strong>must</strong> fill every requested field unless it is marked optional.</li>
<li>In France, you should use the name of the "departement" to fill the <em>State or Province Name</em>.</li>
<li>Use your company name for <em>Organization Name</em>.</li>
<li>Be sure to fill the chosen website URL for <em>Common Name</em>. <strong>Don't fill your personal name for a website SSL certificate request!</strong></li>
</ul>
</li>
<li>Removed the passphrase from the private key. You have to do this, so that it won't be needed when starting the webserver. Since this is probably done automatically (at server boot or through automatic management tools), you won't be there to enter the passphrase. <strong>Be sure however that your private key is secure (root user access only), and revoke it as soon as you think it was stolen.</strong></li>
<li>Generates the certificate.</li>
</ul>


<h2>Move the files to the correct place</h2>

<pre><code>sudo mv server.crt /etc/ssl/application_name.crt
sudo mv server.key /etc/ssl/private/application_name.key
</code></pre>

<h2>Change the permissions of the files to make them safe</h2>

<pre><code>sudo chown root:ssl-cert /etc/ssl/private/application_name.key
sudo chmod 0600 /etc/ssl/private/application_name.key
sudo chmod 0600 /etc/ssl/certs/application_name.crt 
sudo chown root:ssl-cert /etc/ssl/certs/application_name.crt 
</code></pre>

<h2>Update the configuration of your webserver to add a SSL host</h2>

<p><em>This tutorial is written for nginx v0.7.65. It's quite old but it's the default package on Ubuntu 10.04.3 LTS. I however recommend you to update it by installing it directly from the source, it's quite easy!</em></p>

<p>Adding the SSL host to your nginx configuration file essentially means to add the following lines:</p>

<pre><code>server {
    listen &lt;%= app_port_ssl %&gt;;
    client_max_body_size 500M;
    server_name &lt;%= server_name %&gt;;
    ssl                     on;
    ssl_certificate         /etc/ssl/certs/application_name.crt;
    ssl_certificate_key     /etc/ssl/private/application_name.key;
    ssl_session_timeout     5m;

    [...remaining configuration]
}
</code></pre>

<p>You have to make some changes for the location you're proxying to Rails too.</p>

<p>In our case, we have this root location:</p>

<pre><code>location / {
  # Returns file if it exists, else send to app server's location
  try_files $uri @app_server;
}
</code></pre>

<p>Our standard (ie. HTTP) <code>@app_server</code> location is defined like this:</p>

<pre><code>location @app_server {
  proxy_set_header X-Forwarded-For$proxy_add_x_forwarded_for;
  proxy_set_header Host $http_host;
  proxy_pass http://&lt;%= application %&gt;_app_server;
}
</code></pre>

<p>The one for SSL is like this:</p>

<pre><code>location @app_server {
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Host $http_host;
  proxy_pass http://&lt;%= application %&gt;_app_server;
  proxy_redirect off;
  proxy_max_temp_file_size 0;
}
</code></pre>

<p>You see some additional proxy directives, in particular <code>proxy_set_header X-Forwarded-Proto https;</code>, they ensure that Rails can correctly detect the request was made through HTTPS, not HTTP.</p>

<p>The remaining configuration may be a copy of your HTTP server configuration, in which case your server will do both HTTP and HTTPS the same way, or a specific configuration if you want to process different locations, perform redirections, etc.</p>

<h2>Update Rails application to require SSL for specific actions</h2>

<p>Our goal is to have only specific controller actions requiring SSL. We don't want everything to be secured, this would unnecessarily increase our server's load.</p>

<p>We assume that our webserver-level configuration (nginx in our case) is not managing HTTP/HTTPS routing (we could do this through webserver rules, however we consider that this is business/app-level related, so this should be done at app-level).</p>

<p><em>This tutorial is made for Rails 3.0.x (tested with 3.0.12)</em></p>

<h3>Install <code>ssl_requirement</code> gem</h3>

<p>Use this fork: <a href="https://github.com/bartt/ssl_requirement">https://github.com/bartt/ssl_requirement</a> and follow the guide.</p>

<p><strong>If you want the short way...</strong></p>

<p>Add to your Gemfile</p>

<pre><code>gem 'bartt-ssl_requirement', '~&gt;1.4.0', :require =&gt; 'ssl_requirement'
</code></pre>

<h3>Configure Devise for SSL</h3>

<p>Add the following code at the bottom of your <code>Application</code> class definition within <code>config/application.rb</code>:</p>

<pre><code>config.to_prepare do
  Devise::RegistrationsController.ssl_required :new, :create
  Devise::SessionsController.ssl_required :new, :create
end
</code></pre>

<p>Add to your <code>ApplicationController</code></p>

<pre><code>include ::SslRequirement
</code></pre>

<p>For any other controller action you want SSL, add this  to your controller class:</p>

<pre><code>ssl_required :action_name
</code></pre>

<h3>Review routes when SSL is required</h3>

<p>You probably don't want to limit all your secured routes to SSL. In most cases, it's better if you don't, so that the user gets a redirection when he tries to access through <code>http</code> a route with ssl required.</p>

<p>However, you can't do so for <code>POST</code> routes: redirection won't work, since it will redirect to a <code>GET</code>. For these routes, you can add the SSL constraint on the route, so that the user get a <code>404</code> error when he tries to mess with the URL's protocol!</p>

<p>If you're using Devise, you'll probably want to do this for you <code>user_registration</code> and <code>user_session</code> <code>POST</code> routes.</p>

<p>You will have to override Devise's defaults routes for <code>sessions</code> and <code>registrations</code> controllers. For the override, you'll use:</p>

<pre><code>devise_for  :users, 
  :skip =&gt; [:registrations, :sessions]
</code></pre>

<p>This simply tells Devise to skip the registrations and sessions routes, as you'll give them yourself to enforce the SSL requirement.</p>

<p>And now, you create these routes by yourself:</p>

<p>``` ruby</p>

<pre><code>devise_scope :user do
  scope '/users' do

    # Setting up registrations routes manually for https on create
    get '/cancel',        :to =&gt; 'devise/registrations#cancel', :as =&gt; :cancel_user_registration
    post '',              :to =&gt; 'devise/registrations#create',
                          :constraints =&gt; { :protocol =&gt; secured_protocol },
                          :as =&gt; :user_registration
    get '/sign_up',       :to =&gt; 'devise/registrations#new', :as =&gt; :new_user_registration
    get '/edit',          :to =&gt; 'devise/registrations#edit', :as =&gt; :edit_user_registration
    put '',               :to =&gt; 'devise/registrations#update'
    delete '',            :to =&gt; 'devise/registrations#destroy'

    # Sessions routes for https on create
    get '/sign_in',       :to =&gt; 'devise/sessions#new', :as =&gt; :new_user_session
    post '/sign_in',      :to =&gt; 'devise/sessions#create', :as =&gt; :user_session,
                          :constraints =&gt; { :protocol =&gt; secured_protocol }
    delete '/sign_out',   :to =&gt; 'devise/sessions#destroy', :as =&gt; :destroy_user_session
  end
end
</code></pre>

<p>```</p>

<h2>Change your links to go <code>https</code></h2>

<p>This involves using the <code>_url</code> helper instead of the <code>_path</code> one, and adding this option: <code>:protocol =&gt; "https"</code>.</p>

<p>Be sure to change the url of forms matching SSL-enabled routes, or you'll get <code>404</code>s!</p>

<h2>Test</h2>

<p>You should now be able to test this configuration with your browser. You will need to deploy your updated app to a staging machine, unless your development is SSL-capable.</p>

<p>You may encounter some issues with your browser recognizing the issued certificate. The browser may complain it is signed by an unknown authority. This may happen when an unknown intermediate certification authority is used. In this case, you have to modify your certificate file to include the complete chain of certificates. Be sure to insert the certificates from the chain <strong>above</strong> your site's certificate!</p>

<p>An example line to do this:</p>

<p><code>
cat bundled_certificate_chain.crt &gt;&gt; server.crt
</code></p>

<p>You can use this service to check your server is sending the expected certificate chain: <a href="http://www.sslshopper.com/ssl-checker.html">http://www.sslshopper.com/ssl-checker.html</a></p>

<h2>References</h2>

<ul>
<li><a href="http://wiki.nginx.org/HttpSslModule">http://wiki.nginx.org/HttpSslModule</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
